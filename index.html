<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Problem Tracker Dashboard</title>
  <script defer src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">

  <div class="max-w-6xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6 text-center">Problem Tracker Dashboard</h1>

    <!-- Add Row Button -->
    <div class="flex justify-end mb-4">
      <button id="add-row" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add Row</button>
      <button id="export-excel" class="ml-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Export to Excel</button>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto mb-10">
      <table class="min-w-full bg-white border rounded-lg shadow">
        <thead>
          <tr class="bg-gray-200">
            <th class="py-2 px-4 border">Name</th>
            <th class="py-2 px-4 border">Problem</th>
            <th class="py-2 px-4 border">Status</th>
            <th class="py-2 px-4 border">Action</th>
          </tr>
        </thead>
        <tbody id="sheet-body"></tbody>
      </table>
    </div>

    <!-- Chart -->
    <div class="bg-white p-4 rounded shadow">
      <canvas id="statusChart" height="100"></canvas>
    </div>

    <!-- Footer -->
    <footer class="mt-10 text-center text-sm text-gray-500">
      Created by - Toshit Kumar (ICT360 process trainer)
    </footer>
  </div>

  <!-- SCRIPT -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const tbody = document.getElementById("sheet-body");
      const addRowBtn = document.getElementById("add-row");
      const exportBtn = document.getElementById("export-excel");

      let data = JSON.parse(localStorage.getItem("problemData")) || [];

      function saveData() {
        localStorage.setItem("problemData", JSON.stringify(data));
      }

      function updateChart() {
        const statusCount = { Open: 0, "In Progress": 0, Closed: 0 };
        data.forEach(row => statusCount[row.status]++);

        const chartData = {
          labels: Object.keys(statusCount),
          datasets: [{
            data: Object.values(statusCount),
            backgroundColor: ["#f87171", "#facc15", "#4ade80"]
          }]
        };

        const config = {
          type: "doughnut",
          data: chartData,
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "top"
              }
            }
          }
        };

        if (window.statusChart) {
          window.statusChart.destroy();
        }

        const ctx = document.getElementById("statusChart").getContext("2d");
        window.statusChart = new Chart(ctx, config);
      }

      function renderTable() {
        tbody.innerHTML = "";
        data.forEach((row, index) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="border px-4 py-2"><input type="text" value="${row.name}" class="w-full px-2 py-1 border rounded" /></td>
            <td class="border px-4 py-2"><input type="text" value="${row.problem}" class="w-full px-2 py-1 border rounded" /></td>
            <td class="border px-4 py-2">
              <select class="status w-full px-2 py-1 border rounded">
                <option ${row.status === "Open" ? "selected" : ""}>Open</option>
                <option ${row.status === "In Progress" ? "selected" : ""}>In Progress</option>
                <option ${row.status === "Closed" ? "selected" : ""}>Closed</option>
              </select>
            </td>
            <td class="border px-4 py-2 text-center">
              <button class="delete bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
            </td>
          `;

          // Change listeners
          tr.querySelectorAll("input, select").forEach((el, i) => {
            el.addEventListener("input", () => {
              const newRow = {
                name: tr.querySelector("input:nth-child(1)").value,
                problem: tr.querySelector("input:nth-child(2)").value,
                status: tr.querySelector("select").value
              };
              data[index] = newRow;
              saveData();
              updateChart();
            });
          });

          // Delete
          tr.querySelector(".delete").addEventListener("click", () => {
            data.splice(index, 1);
            saveData();
            renderTable();
            updateChart();
          });

          tbody.appendChild(tr);
        });
      }

      addRowBtn.addEventListener("click", () => {
        data.push({ name: "", problem: "", status: "Open" });
        saveData();
        renderTable();
        updateChart();
      });

      exportBtn.addEventListener("click", () => {
        const sheet = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, sheet, "Problem Tracker");
        XLSX.writeFile(wb, "Problem-Tracker.xlsx");
      });

      // First time load
      renderTable();
      updateChart();
    });
  </script>
</body>
</html>
